from backend.app.db.session import SessionLocal
from backend.app.db.models import AmalateJamaate
from sqlalchemy import text

WILAYA_JAMAA = {
    "عمالة الدار البيضاء": [
        "عمالة مقاطعات الدارالبيضاء-انفا",
        "عمالة مقاطعات الفداء-مرس السلطان",
        "عمالة مقاطعات عين السبع الحي-المحمدي",
        "عمالة مقاطعة عين الشق",
        "عمالة مقاطعة الحي الحسني",
        "عمالة مقاطعات ابن مسيك",
        "عمالة مقاطعات سيدي البرنوصي",
        "عمالة مقاطعات مولاي رشيد"
    ],
    "إقليم الجديدة": [
        "جماعة الجديدة",
        "جماعة الزمامرة",
        "جماعة سيدي بنور",
        "جماعة أولاد فرج",
        "جماعة أولاد عبو",
        "جماعة السوالم",
        "جماعة سيدي عيسى بن علي",
        "جماعة سيدي إبراهيم دوحو",
        "جماعة سيدي سليمان الشراعرة",
        "جماعة سيدي عابد",
        "جماعة سيدي مسعود",
        "جماعة مولاي عبد الله"
    ],
    "إقليم النواصر": [
        "جماعة النواصر",
        "جماعة بني يخلف",
        "جماعة سيدي المختار",
        "جماعة للا عائشة",
        "جماعة سيدي عبد الله الغرباوي",
        "جماعة أولاد حدو"
    ],
    "إقليم مديونة": [
        "جماعة مديونة",
        "جماعة أولاد عبو",
        "جماعة أولاد حريز",
        "جماعة سيدي سليمان",
        "جماعة سيدي قاسم",
        "جماعة سيدي علي بن حمدوش"
    ],
    "إقليم بنسليمان": [
        "جماعة بنسليمان",
        "جماعة أولاد فتوح",
        "جماعة أولاد غانم",
        "جماعة سيدي يحيى زعير",
        "جماعة سيدي عبد الكريم",
        "جماعة سيدي علي بن حمدوش"
    ],
    "إقليم برشيد": [
        "جماعة برشيد",
        "جماعة سيدي قاسم",
        "جماعة سيدي عابد",
        "جماعة أولاد عبو",
        "جماعة أولاد حريز",
        "جماعة الزمامرة",
        "أولاد غانم",
        "سيدي يحيى زعير",
        "أولاد فتوح",
        "سيدي عبد الكريم"
    ],
    "إقليم سطات": [
        "جماعة سطات",
        "جماعة أولاد سعيد",
        "جماعة أولاد فتوح",
        "جماعة سيدي عبد الله",
        "جماعة سيدي يحيى الغرب",
        "جماعة أولاد عبو",
        "سطات (حضرية)",
        "أولاد سعيد",
        "أولاد فتوح",
        "سيدي يحيى الغرب",
        "سيدي عبد الله"
    ],
    "إقليم سيدي بنور": [
        "جماعة سيدي بنور",
        "جماعة الزمامرة",
        "جماعة أولاد فرج",
        "جماعة أولاد عبو",
        "جماعة السوالم",
        "جماعة سيدي عيسى بن علي"
    ],
    "عمالة المحمدية": [
        "المحمدية (جماعة حضرية)",
        "بن أحمد (جماعة قروية)"
    ],
    "عمالة فاس": [
        "مقاطعة فاس المدينة",
        "مقاطعة فاس الجديدة",
        "مقاطعة سيدي حريز",
        "مقاطعة جنان الورد",
        "مقاطعة سيدي بوعفيف",
        "مقاطعة الزهور",
        "مقاطعة سيدي إبراهيم",
        "مقاطعة الدار البيضاء",
        "أولاد نير",
        "سيدي يحيى الغرب",
        "أولاد مبارك",
        "سيدي حراث"
    ],
    "عمالة مكناس": [
        "مقاطعة مكناس – منصور",
        "مقاطعة مكناس – الحمرية",
        "مقاطعة مكناس – زمزم",
        "مقاطعة مكناس – البراج",
        "مقاطعة مكناس – ميسور",
        "مقاطعة مكناس – سبو",
        "أولاد نير",
        "سيدي عبد الكريم",
        "أولاد بوجمعة"
    ],
    "إقليم الحاجب": [
        "جماعة الحاجب",
        "أولاد بوجمعة",
        "أولاد فارس",
        "سيدي عيسى بن إبراهيم",
        "أولاد مبارك",
        "سيدي يحيى الغرب"
    ],
    "إقليم إفران": [
        "جماعة إفران",
        "آزرو",
        "تيمحضيت",
        "واد Ifrane",
        "سيدي علال البوشواري"
    ],
    "إقليم بولمان": [
        "جماعة بولمان",
        "أمزر",
        "تيسفان",
        "إمدوكل",
        "أيت إسحاق",
        "أيت إيعزة",
        "أيت ولال"
    ],
    "إقليم تازة": [
        "جماعة تازة",
        "تاهلة",
        "أولاد بوعلي",
        "أيت إسحاق",
        "غفساي",
        "دار النخل",
        "أولاد داود",
        "أيت سغروشن"
    ],
    "إقليم تاونات": [
        "جماعة تاونات",
        "تيسة",
        "بروان",
        "أكنول",
        "الغزاوة",
        "واد المخازن",
        "أيت عياش",
        "أيت تمليل"
    ],
    "إقليم صفرو": [
        "جماعة صفرو",
        "إمّوكر",
        "الرواشد",
        "أيت إسحاق",
        "تيسفان",
        "بني مطير",
        "أيت بويوسف"
    ],
    "إقليم مولاي يعقوب": [
        "جماعة مولاي يعقوب",
        "سيدي حرازم",
        "سيدي يحيى زايد",
        "أولاد بن عبو",
        "أولاد مبارك",
        "سيدي عبد الله"
    ],
    "عمالة الرباط": [
        "مقاطعة الرباط",
        "مقاطعة أكدال – الرياض",
        "مقاطعة تاوريرت",
        "مقاطعة حي الياسمين",
        "سلا الجديدة",
        "تمارة الحضارية",
        "سيدي المختار",
        "سيدي عثمان"
    ],
    "عمالة سلا": [
        "مقاطعة سلا",
        "مقاطعة طابريكت",
        "مقاطعة سيدي بنور"
    ],
    "عمالة القنيطرة": [
        "مقاطعة القنيطرة",
        "مقاطعة للا ميمونة",
        "مقاطعة بنية يخلف",
        "أولاد عياش",
        "سيدي لحسن",
        "سيدي عيسى بن إبراهيم"
    ],
    "عمالة الصخيرات تمارة": [
        "جماعة تمارة",
        "جماعة الصخيرات",
        "جماعة سلا الجديدة",
        "جماعة سيدي المختار",
        "جماعة سيدي عثمان"
    ],
    "إقليم سيدي قاسم": [
        "جماعة سيدي قاسم",
        "أولاد فرج",
        "سيدي أحمد بن عائشة",
        "أولاد بوعلي",
        "أولاد حمدوش",
        "سيدي سليمان الشراعرة",
        "أولاد عبو"
    ],
    "إقليم سيدي سليمان": [
        "جماعة سيدي سليمان",
        "سيدي يحيى الغرب",
        "أولاد سعيد",
        "سيدي عبد الله",
        "أولاد فتوح",
        "أولاد عبو"
    ],
    "إقليم الخميسات": [
        "جماعة الخميسات",
        "أولاد عمير",
        "سيدي الطيب",
        "أولاد زيان",
        "سيدي بوقنادل",
        "أولاد فرج"
    ],
    "إقليم العرائش": [
        "جماعة العرائش",
        "كبدانة",
        "زومي",
        "القصر الكبير",
        "سيدي يوسف بن علي",
        "أولاد ميمون",
        "بومخن",
        "الواد"
    ]
}

def import_amalate_jamaate():
    db = SessionLocal()
    try:
        records = []
        jamaa_id_counter = 1

        for wilaya_name, jamaa_list in WILAYA_JAMAA.items():
            # Get wilaya info from jihate table
            result = db.execute(
                text("""
                    SELECT jiha_id, jiha, wilaya_id, wilaya 
                    FROM jihate 
                    WHERE wilaya = :wilaya
                """),
                {"wilaya": wilaya_name}
            ).fetchone()
            
            if not result:
                print(f"Warning: Wilaya '{wilaya_name}' not found in jihate table")
                continue
                
            jiha_id, jiha, wilaya_id, wilaya = result
            
            # Add all communes for this wilaya
            for jamaa in jamaa_list:
                records.append(AmalateJamaate(
                    amala_jamaa_id=jamaa_id_counter,
                    amala_jamaa=jamaa,
                    wilaya_id=wilaya_id,
                    wilaya=wilaya,
                    jiha_id=jiha_id,
                    jiha=jiha
                ))
                jamaa_id_counter += 1

        # Insert all records
        for record in records:
            db.add(record)
        db.commit()
        print(f"Successfully imported {len(records)} communes (jamaa)")
        
    except Exception as e:
        print(f"❌ Error: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    import_amalate_jamaate()